# How to use analysis modules in the Single cell/Single-nucleus ATAC Seq workflow (ScATACSeq)

This repository contains a collection of analysis modules designed to process and analyze single cell ATAC (scATAC) data from 10X sequencing technology. 

---------------------------------------------------------------------------------------
**Data for testing phase**

  - Control vs condition (min. 3+3 samples)
  - Number of cells/sample - size of datasets might determined packages/pipelines to be used
  - Single cell/Single-nucleus ATAC?
  - Integration of scRNA-seq and scATAC-seq data from the same biological system (multiple modalities)
  - Pipeline for same samples but not same cells with scRNA-seq and scATAC-seq
  - Annotate scATAC-seq cells via label transfer by using scRNA data: cell type annotation
  - Available bulk ATAC-seq data for the same samples () - this could be used for cell type annotation


**Aim**

To characterize the cell landscape of the tissue at single cell resolution. Questions to address:
  - Chromatin accessibility in the brain of X condition.
  - Chromatin accessibility in the brain of X condition per cell type.


**Methods**

[Signac package](https://stuartlab.org/signac/)

[Signac and Seurat vignette](https://satijalab.org/seurat/articles/seurat5_atacseq_integration_vignette)


**References**

- [Jessa et al., 2022](https://www.nature.com/articles/s41588-022-01205-w). Human/mouse pediatric H3K27M gliomas; scATAC joined with sc/sNRNA along with pipeline; scMultiome data. 
   > [Available code](https://github.com/fungenomics/HGG-oncohistones?tab=readme-ov-file)
  
   > [Normal human fetal brain scRNA-seq reference dataset](https://github.com/fungenomics/HGG-oncohistones#human-fetal-brain-scrnaseq-data)

- [Kim et al., 2024](https://www.nature.com/articles/s41467-024-44742-0#Sec7). Leveraging single-cell ATAC-seq and RNA-seq to identify disease-critical fetal and adult brain cell types.

- [Zeng et.al, 2024](https://www.nature.com/articles/s43588-024-00622-7). Deciphering cell types by integrating scATAC-seq data with genome sequences. SANGO method for accurate single-cell annotation by integrating genome sequences around the accessibility peaks within scATAC data.
  > datasets BoneMarrowA, BoneMarrowB, LungA, LungB, Kidney, Liver, Heart, LargeIntestineA, LargeIntestineB, SmallIntestine, WholeBrainA, WholeBrainB, Cerebellum and PreFrontalCortex are derived from the adult mouse atlas data
 
  > datasets are sequenced using the sciATAC-seq technology56 and annotated through the mm9 reference genome
 
  > [SANGO GitHub code](https://github.com/cquzys/SANGO)
  
  
- [Fang. et al., 2021](https://www.nature.com/articles/s41467-021-21583-9) Comprehensive analysis of single cell ATAC-seq data with SnapATAC.
  
  > New method called SnapATAC —that does not require population-level peak annotation prior to clustering. Instead, it resolves cellular heterogeneity by directly comparing the similarity in genome-wide accessibility profiles between cells. We also adopt a technique, ensemble Nyström method20,21, that improves the computational efficiency and enables the analysis of scATAC-seq from up to a million cells on typical hardware.
  
  > SnapATAC also incorporates many existing tools, such as integration of scATAC-seq and scRNA-seq dataset19, prediction of enhancer–promoter interaction, discovery of key transcription factors22, identification of differentially accessible elements23, construction of trajectories during cellular differentiation, correction of batch effect24 and classification of new dataset based on existing cell atlas19, into one single package to maximize its utility and functionalities.
  
  > [SnapTools GitHub pipeline](https://github.com/r3fang/SnapTools)
 
  > [SnapATAC GitHub pipeline](https://github.com/r3fang/SnapATAC)

- [Zu et al., 2023](https://www.nature.com/articles/s41586-023-06824-9). Single-cell analysis of chromatin accessibility in the adult mouse brain.
  
  > A comprehensive atlas of candidate cis-regulatory DNA elements (cCREs) in the **adult mouse brain**, generated by analysing chromatin accessibility in 2.3 million individual brain cells from 117 anatomical dissections.
  

- [Chen et al., 2019](https://link.springer.com/article/10.1186/s13059-019-1854-5) Assessment of computational methods for the analysis of single-cell ATAC-seq data.
  
  > Benchmarking paper
  
  > Human hematopoiesis I (Buenrostro et al. [21]); sci-ATAC-seq mouse tissues (Cusanovich et al. [1]); Human hematopoiesis II (10X PBMCs); Simulated scATAC-seq datasets


- [Berest et al., 2022](https://link.springer.com/protocol/10.1007/978-1-0716-2756-3_15) Integration of scATAC-Seq with scRNA-Seq Data.
  
  > python but also R packages utilized for integration
  
  > might be useful, not sure - TO READ

- [Altay and Vingron, 2024](https://academic.oup.com/nargab/article/6/4/lqae135/7815643) scATAcat: cell-type annotation for scATAC-seq data.
  
  > [scATAcat is available as a python package](https://github.com/aybugealtay/scATAcat)
  
  > scATAcat is a tool for annotation of cell-types in scATAC-seq data based on characterized bulk ATAC-seq data.



---------------------------------------------------------------------------------------

**Analysis modules**

Each module is self-contained and can be executed independently or as part of a larger analysis pipeline. Below is a summary of each analysis module, including whether they are required or optional. Furthermore, the analysis modules should be run in the following recommended order:

1. `cellranger-analysis` module (description="Pipeline for running and summarizing Cell Ranger count for single or multiple libraries.", required=True)

   - [Chromium Single Cell ATAC (Assay for Transposase Accessible Chromatin) 10X](https://www.10xgenomics.com/support/single-cell-atac)
   - [Cell Ranger ATAC](https://software.10xgenomics.com/single-cell-atac/software/overview/welcome)
   - cellranger-atac/2.1.0 module on St Jude HPC (and older versions as well)
   - [ctg-sc-atac-10x](https://github.com/perllb/ctg-sc-atac-10x): Nextflow pipeline for preprocessing of 10x chromium sc-ATAC data with cellranger. This also includes: `multiQC: Compile fastQC and cellranger count metrics in multiqc report`.
   
   
2. `upstream-analysis` module (description="Pipeline for estimating QC metrics and filtering low quality cells.", required=True)

   - `Peak/Cell matrix`. This is analogous to the gene expression count matrix used to analyze single-cell RNA-seq. However, instead of genes, each row of the matrix represents a region of the genome (a peak), that is predicted to represent a region of open chromatin. Each value in the matrix represents the number of Tn5 integration sites for each single barcode (i.e. a cell) that map within each peak. You can find more detail on the [10X Website](https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/output/matrices).
   
   > Peak calling for snATAC-seq data. To call peaks on snATAC-seq data (from regular snATAC-seq and from snMultiome-seq), we used the MACS2 tool (v.2.2.7.1)72 through the CallPeaks function of the Signac package (v.1.3.0, https://github.com/timoast/signac). We further removed peaks from the Y chromosome, as well as those overlapping genomic regions containing ‘N’. All peaks were resized to 501 bp centred at the peak summit defined by MACS2. We next performed the iterative removal procedure described previously6 to get the set of non-overlapping peaks. In brief, we start with retaining the most significant peak by MACS2 peak score (−log10[q]), removing all peaks that have direct overlap with it. We repeat this procedure for the remaining peaks, until we have the set of non-overlapping peaks. The resulting sample peak set was used to calculate peak-count matrix using FeatureMatrix from the Signac package, which was also used for downstream analysis.
   
   - `Fragment file`. This represents a full list of all unique fragments across all single cells. It is a substantially larger file, is slower to work with, and is stored on-disk (instead of in memory). However, the advantage of retaining this file is that it contains all fragments associated with each single cell, as opposed to only fragments that map to peaks. More information about the fragment file can be found on the [10x Genomics website](https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/output/fragments) or on the [sinto website](https://timoast.github.io/sinto/basic_usage.html#create-scatac-seq-fragments-file).
   - `Computing QC Metrics`
   
   > Quality control of snATAC-seq data. Quality-control filtering of the snATAC-seq datasets was performed using functions from the Signac package. Filters that were applied for the cell calling include: 1,000 < number of fragments in peaks < 20,000; percentage of reads in peaks > 15; ENCODE blacklist regions percentage < 0.05 (https://www.encodeproject.org/annotations/ENCSR636HFF/); nucleosome banding pattern score < 5; and enrichment-score for Tn5-integration events at transcriptional start sites > 2. Open chromatin regions were annotated with the R package ChIPseeker (v.1.26.2)73 using transcript database TxDb.Hsapiens.UCSC.hg38.knownGene. The promoter region was specified (−1000,100) relative to the TSS.
   
   - `Normalization and linear dimensional reduction`
   - `Non-linear dimension reduction and clustering`
   - `Create a gene activity matrix`

 > Normalization, feature selection, dimensionality reduction and clustering of snATAC-seq data. The filtered peak-count matrix was normalized using term frequency-inverse document frequency (TF-IDF) normalization implemented in the Signac package. This procedure normalizes across cells, accounting for differences in coverage across them and across peaks, giving higher values to the rarer peaks. All peaks were used as features for dimensional reduction. We used the RunSVD Signac function to perform singular value decomposition on the normalized TF-IDF matrix, a method that is also known as latent semantic indexing (LSI) dimension reduction. The resulting 2:30 LSI components were used for nonlinear dimensionality reduction using the RunUMAP function from the Seurat package. The nuclei were clustered using a graph-based clustering approach implemented in Seurat. First, we used the Seurat function FindNeighbors to construct a shared nearest neighbour graph using the 2:30 LSI components. We next used the FindClusters function to iteratively group nuclei together while optimizing modularity using the Louvain algorithm.

   - `03_run_scDblFinder.Rmd`. To identify doublets from secondary motor cortex single-nucleus ATAC-seq datasets, we use single-cell RNA-seq doublets detection algorithm Scrublet

     > 01A_scATAC-Seq_data_Create_Matrice_Assay_Object_v3.R; 01B_scATAC-Seq_data_Combined_obj_Filter.new_v2.R


 
3. `integrative-analysis` module (description="Pipeline for Integrative analysis.", required=True)
- Requires post-processing integration since the RNA and ATAC data come from separate experiments, even if matched at the cell level.
- The integration is usually performed after the individual data processing, and tools like Seurat’s CCA or Harmony can be used to align the RNA and ATAC datasets.
- Integration is not as straightforward as in the multiomic pipeline, since the two datasets are processed independently before integration.

  > Tools for Integration:
    > - Seurat: Seurat can integrate the two datasets via CCA (Canonical Correlation Analysis) or more recent multi-modal integration techniques (for version 4+).
    > - Harmony: Another integration tool that is commonly used for aligning datasets after normalization.
    > - 02_scATAC-Seq_data_Integration-across-Modalities; 03_scATAC-Seq_data_Integration-across-Modalities_RNA_UMAP.R; 05A_scATAC-Seq_data_Integration-across-Modalities.Subset.Samples.R; 07_scATAC-Seq_data_Integration-across-Samples.Harmony.R; 08_scATAC-Seq_data_Integration-across-Samples.Anchors.R
 

4. `cell-types-annotation` module (description="Pipeline for annotating cell types.", required=True)
  
   - Marker-based annotation
   - Reference-based label-transfer, either scATAC or bulkATAC seq data (see scATAcat method in the **References**)
   - Integration with scRNA-seq: Integrate single-cell ATAC-seq with single-cell RNA-seq data to annotate cell types and identify transcriptional regulators linked to chromatin accessibility changes.
    
    > How to do Cell type annotation:
       a) **Projection of malignant samples onto healthy tissue UMAP**
       b) Bridge integration to label cells
       c) Cell type-specific peaks for cell type annotation


5. `peak-calling` module (description="Pipeline for calling peaks and Motif Enrichment Analysis.", required=False)

   - Transcription Factor Binding Motifs: Use tools like chromVAR, Homer, or MEME to search for enriched motifs in open chromatin regions and predict active transcription factors or regulatory proteins in different cell clusters or conditions.
   - Comparing Motifs: Compare motif enrichment across cell populations to identify differentially active transcription factors and co-factors that might drive cell-specific or condition-specific gene regulation.
   - Building trajectories with Monocle 3
   - Transcription factor motif analysis; Call peaks with MACS2

    > Transcription factor footprinting analysis/06_scATAC-Seq_data_Peak_calling.R
 
5. `differential-accessibility-analysis` module (description="Pipeline for differentially expressed genes.", required=False)
   
   - Identify differential chromatin accessibility between conditions (e.g., disease vs. healthy, treatment vs. control) using tools like edgeR, DESeq2, or MAST (for single-cell RNA-seq).
   - Find differentially accessible peaks (DAPs) to discover regions of the genome whose accessibility changes in response to biological conditions or cell states.
   - [Find differentially accessible peaks between cell types](https://stuartlab.org/signac/articles/pbmc_vignette.html)

   > 09_scATAC-Seq_data_DE_Analysis_Combined.R


6. `plotting-genomic-regions-analysis` module. We can plot the frequency of Tn5 integration across regions of the genome for cells grouped by cluster, cell type, or any other metadata stored in the object for any genomic region using the CoveragePlot() function.

   > I have done that...

7. `gene-ontology-enrichment-analysis` module. 

   - Gene ontology (GO) enrichment analysis. Gene set enrichment analysis was processed with ‘enrichGO’ function (parameters: OrgDb = org.Hs.eg.db, ont = ‘BP’) of the clusterProfiler package (version 4.4.4). The marker peaks of cell type used as input (FDR ≤ 0.05 & Log2FC ≥ 0.25) were annotated based on proximity to the TSS of the nearest genes.

8. `trajectory-analysis` module

   - Pseudo-Trajectory: Use tools like Monocle or Slingshot to reconstruct cellular differentiation trajectories based on chromatin accessibility. This allows the identification of chromatin dynamics during transitions from one cell state to another (e.g., stem cell differentiation, immune response activation).
   - Cell Fate Decisions: Track changes in chromatin accessibility that correlate with specific stages of differentiation or responses to stimuli.


## Contact

Contributions, issues, and feature requests are welcome! Please feel free to check [issues](https://github.com/stjude-dnb-binfcore/sc-atac-seq/issues).

---

*These tools and pipelines have been developed by the Bioinformatic core team at the [St. Jude Children's Research Hospital](https://www.stjude.org/). These are open access materials distributed under the terms of the [BSD 2-Clause License](https://opensource.org/license/bsd-2-clause), which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.*
